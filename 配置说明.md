# MT Photos AI 配置说明

## 📁 项目文件结构

### 核心配置文件

| 文件名 | 用途 | 说明 |
|--------|------|------|
| `docker-compose-openvino.yml` | OpenVINO版本部署 | 使用Intel OpenVINO硬件加速，推荐用于Intel CPU/集成显卡 |
| `docker-compose.yml` | CPU版本部署 | 纯CPU运行，兼容性最好，适用于所有硬件 |
| `Dockerfile.openvino` | OpenVINO镜像构建 | OpenVINO版本的Docker镜像定义 |
| `Dockerfile` | CPU镜像构建 | CPU版本的Docker镜像定义 |

### 依赖文件

| 文件名 | 用途 | 说明 |
|--------|------|------|
| `requirements-openvino.txt` | OpenVINO Python依赖 | 包含OpenVINO相关包 |
| `requirements.txt` | CPU Python依赖 | 标准CPU版本依赖 |
| `server.py` | 主服务程序 | FastAPI服务端代码 |
| `immich_adapter.py` | Immich适配器 | 兼容Immich机器学习API |

## 🚀 快速部署

### OpenVINO版本（推荐）

**适用场景：** Intel CPU、Intel集成显卡、性能要求高

```bash
# 构建并启动OpenVINO版本
docker-compose -f docker-compose-openvino.yml up -d

# 查看日志
docker-compose -f docker-compose-openvino.yml logs -f

# 停止服务
docker-compose -f docker-compose-openvino.yml down
```

**优势：**
- ✅ Intel硬件加速
- ✅ 更快的推理速度
- ✅ 更低的CPU占用
- ✅ 支持Intel集成显卡

### CPU版本（兼容性最好）

**适用场景：** 任何硬件、AMD CPU、追求兼容性

```bash
# 构建并启动CPU版本
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

**优势：**
- ✅ 硬件兼容性最好
- ✅ 支持AMD CPU
- ✅ 配置简单
- ✅ 稳定性高

## ⚙️ 配置说明

### 关键环境变量

| 变量名 | OpenVINO版本 | CPU版本 | 说明 |
|--------|-------------|---------|------|
| `DEVICE` | `openvino` | `cpu` | 设备类型 |
| `OPENVINO_DEVICE` | `AUTO` | - | OpenVINO设备选择 |
| `MODEL_TTL` | `600` | `300` | 模型缓存时间(秒) |
| `API_AUTH_KEY` | `mt_photos_ai_extra` | `mt_photos_ai_extra` | API认证密钥 |

### 模型路径配置

所有版本都已配置统一的模型缓存路径：

```
model-cache/
├── clip/                    # CLIP文本图像模型
├── facial-recognition/      # 人脸识别模型
├── paddleocr/              # PaddleOCR基础模型
└── paddlex/                # PaddleX文档处理模型
```

**关键配置：**
- `PADDLEOCR_MODEL_DIR=/model-cache/paddleocr`
- `PADDLEX_HOME=/model-cache/paddlex`
- 卷映射：`./model-cache/paddlex:/root/.paddlex/official_models`

## 🔧 高级配置

### 性能调优

**OpenVINO版本：**
```yaml
environment:
  - OMP_NUM_THREADS=4        # OpenMP线程数
  - MKL_NUM_THREADS=4        # MKL线程数
  - MODEL_TTL=600            # 模型缓存时间
  - OPENVINO_DEVICE=AUTO     # 自动选择最佳设备
```

**CPU版本：**
```yaml
environment:
  - OMP_NUM_THREADS=4        # OpenMP线程数
  - MKL_NUM_THREADS=4        # MKL线程数
  - MODEL_TTL=300            # 模型缓存时间
```

### 内存限制

```yaml
deploy:
  resources:
    limits:
      memory: 6G             # 最大内存使用
    reservations:
      memory: 3G             # 预留内存
```

## 🌐 API 使用

### 服务端点

- **服务地址：** `http://localhost:3004`
- **API文档：** `http://localhost:3004/docs`
- **健康检查：** `http://localhost:3004/`

### 认证

所有API请求需要在Header中添加：
```
Authorization: Bearer mt_photos_ai_extra
```

## 📊 监控和日志

### 查看实时日志

```bash
# OpenVINO版本
docker-compose -f docker-compose-openvino.yml logs -f

# CPU版本
docker-compose logs -f
```

### 健康检查

```bash
# 检查容器状态
docker ps

# 检查服务响应
curl -H "Authorization: Bearer mt_photos_ai_extra" http://localhost:3004/
```

## 🛠️ 故障排除

### 常见问题

1. **端口被占用**
   ```bash
   # 检查端口使用
   netstat -ano | findstr :3004
   ```

2. **内存不足**
   ```bash
   # 调整内存限制
   deploy:
     resources:
       limits:
         memory: 4G  # 减少内存限制
   ```

3. **模型下载失败**
   ```bash
   # 清理模型缓存
   rm -rf model-cache/paddlex/*
   ```

### 日志级别调整

```yaml
environment:
  - LOG_LEVEL=DEBUG  # 开启详细日志
```

## 📝 版本选择建议

| 硬件配置 | 推荐版本 | 理由 |
|----------|----------|------|
| Intel CPU + 集成显卡 | OpenVINO | 硬件加速效果明显 |
| Intel CPU | OpenVINO | CPU优化更好 |
| AMD CPU | CPU | 兼容性最好 |
| 低配置设备 | CPU | 资源占用更少 |
| 生产环境 | OpenVINO | 性能更好 |
| 开发测试 | CPU | 启动更快 |

## 🚀 部署建议

1. **首次部署：** 建议先使用CPU版本测试功能
2. **生产环境：** Intel平台推荐OpenVINO版本
3. **模型缓存：** 确保 `model-cache` 目录有足够空间（约5GB）
4. **网络访问：** 首次启动需要下载模型，确保网络畅通
