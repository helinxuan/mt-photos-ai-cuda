# MT Photos AI 故障排除指南

## 🔧 连接超时和重置错误解决方案

### 错误症状：
```
timeout
ECONNRESET
EPIPE
socket hang up
```

## 🎯 解决步骤

### 1. 检查服务状态
```bash
# 检查容器是否正常运行
docker ps | grep mt-photos-ai

# 查看容器日志
docker logs mt-photos-ai-cpu --tail 50

# 检查内存使用
docker stats mt-photos-ai-cpu
```

### 2. 等待模型完全加载
**首次启动需要等待2-5分钟**，因为需要：
- 下载CLIP模型（约1GB）
- 下载人脸识别模型（约100MB）
- 加载模型到内存

**检查模型是否加载完成：**
```bash
# 查看日志，等待看到这些信息：
# "Application startup complete"
# "Auto-loaded CLIP text model" (如果启用预加载)
docker logs mt-photos-ai-cpu | grep -E "(startup complete|Auto-loaded)"
```

### 3. 测试API可用性
```bash
# 健康检查
curl -X POST "http://192.168.0.3:3004/check" \
  -H "API_AUTH_KEY: mt_photos_ai_extra"

# 如果返回JSON数据，说明服务正常
```

### 4. 调整客户端超时设置
在MT Photos客户端配置中：
```
请求超时时间：120秒（默认可能只有30秒）
重试次数：3次
重试间隔：10秒
```

### 5. 优化服务器资源

**内存要求：**
- 最小：4GB RAM
- 推荐：6GB RAM
- 模型加载时会占用大量内存

**CPU要求：**
- 最小：2核心
- 推荐：4核心或更多

### 6. 分批处理图片
避免同时发送大量图片请求：
```
建议批次大小：5-10张图片
批次间隔：2-3秒
```

### 7. 检查网络连接
```bash
# 测试网络连通性
ping 192.168.0.3

# 测试端口可达性
telnet 192.168.0.3 3004
```

## 🚀 性能优化建议

### 1. 预加载模型
在docker-compose中设置：
```yaml
environment:
  - AUTO_LOAD_TXT_MODAL=on  # 预加载文本模型
```

### 2. 增加资源限制
```yaml
deploy:
  resources:
    limits:
      memory: 6G
    reservations:
      memory: 3G
```

### 3. 调整线程数
根据CPU核心数调整：
```yaml
environment:
  - OMP_NUM_THREADS=4  # 设置为CPU核心数
  - MKL_NUM_THREADS=4
```

## 📊 监控和日志

### 查看实时日志
```bash
docker logs -f mt-photos-ai-cpu
```

### 监控资源使用
```bash
docker stats mt-photos-ai-cpu
```

### 重启服务
```bash
# 通过Dockge界面重启
# 或者命令行：
docker restart mt-photos-ai-cpu
```

## 🔄 常见解决方案

### 问题1：首次启动超时
**解决**：等待5分钟让模型完全加载

### 问题2：内存不足
**解决**：增加服务器内存或减少并发请求

### 问题3：频繁连接重置
**解决**：
1. 检查防火墙设置
2. 增加客户端超时时间
3. 减少并发请求数量

### 问题4：模型加载失败
**解决**：
1. 检查网络连接
2. 清理模型缓存重新下载
3. 检查磁盘空间

## 📞 获取帮助

如果问题仍然存在：
1. 收集完整的错误日志
2. 记录服务器配置信息
3. 记录网络环境信息
