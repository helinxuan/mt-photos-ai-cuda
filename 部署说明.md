# MT Photos AI - Dockge 部署指南

## 📦 部署文件清单

需要传输到目标服务器的文件：
1. `mt-photos-ai-cpu.tar` (Docker镜像文件，3.49GB)
2. `docker-compose.yml` (Docker Compose配置)
3. `部署说明.md` (本文档)

## 🚀 Dockge 部署步骤

### 1. 传输文件到服务器
```bash
# 将以下文件上传到服务器的某个目录（如 /opt/mt-photos-ai/）
- mt-photos-ai-cpu.tar
- docker-compose.yml
```

### 2. 导入Docker镜像
在服务器上执行：
```bash
# 进入文件目录
cd /opt/mt-photos-ai/

# 导入镜像
docker load -i mt-photos-ai-cpu.tar

# 验证镜像导入成功
docker images | grep mt-photos-ai-cpu
```

### 3. 在Dockge中创建Stack

#### 方法一：直接在Dockge中创建
1. 打开Dockge Web界面
2. 点击 "+" 创建新的Stack
3. Stack名称：`mt-photos-ai-cpu`
4. 将 `docker-compose.yml` 的内容复制粘贴到编辑器中

#### 方法二：使用文件夹方式
1. 在Dockge的stacks目录创建文件夹：`mt-photos-ai-cpu`
2. 将 `docker-compose.yml` 放入该文件夹
3. 在Dockge界面刷新即可看到新的Stack

### 4. 修改配置（如果需要）

根据您的服务器环境，可能需要修改 `docker-compose.yml` 中的：

**端口映射**（如果3004端口被占用）：
```yaml
ports:
  - "3005:3004"  # 改为其他端口
```

**设备映射**（如果服务器没有GPU或不需要硬件加速）：
```yaml
# 注释掉或删除这两行
# devices:
#   - /dev/dri:/dev/dri
```

**卷映射路径**（使用现有的Immich缓存路径）：
```yaml
volumes:
  - /opt/stacks/immich/model-cache:/cache
  - /opt/stacks/immich/model-cache/paddleocr:/model-cache/paddleocr
```

### 5. 创建必要目录
```bash
# 在服务器上创建PaddleOCR模型缓存目录（如果不存在）
mkdir -p /opt/stacks/immich/model-cache/paddleocr

# 注意：/opt/stacks/immich/model-cache 应该已经存在（Immich使用的）
```

### 6. 启动Stack
1. 在Dockge界面找到 `mt-photos-ai-cpu` Stack
2. 点击 "Start" 按钮启动
3. 查看日志确认启动成功

### 7. 验证部署
访问：`http://服务器IP:3004`
应该看到：**MT Photos智能识别服务** 页面

## 🔧 环境变量说明

当前配置的环境变量：
- `API_AUTH_KEY=mt_photos_ai_extra` - API认证密钥
- `CLIP_MODEL_NAME=nllb-clip-large-siglip__v1` - CLIP模型名称
- `FACE_MODEL_NAME=antelopev2` - 人脸识别模型
- `DEVICE=cpu` - 使用CPU推理
- `LOG_LEVEL=INFO` - 日志级别

## 📋 API测试

启动成功后可以测试API：
```bash
# 健康检查
curl -X POST "http://服务器IP:3004/check" \
  -H "API_AUTH_KEY: mt_photos_ai_extra"

# 应该返回服务状态信息
```

## ⚠️ 注意事项

1. **磁盘空间**：确保至少有6GB可用空间（镜像3.5GB + 模型缓存2GB）
2. **内存要求**：建议至少4GB RAM
3. **网络访问**：首次启动时需要下载AI模型
4. **防火墙**：确保3004端口（或您修改的端口）可访问
5. **GPU支持**：如果服务器有GPU且想使用，保留 `devices` 配置

## 🛠️ 故障排除

如果启动失败，检查：
1. Docker镜像是否导入成功
2. 目录权限是否正确
3. 端口是否被占用
4. 查看Dockge中的容器日志
